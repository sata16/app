{% extends "base.html" %}
{% block title %}–†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å{% endblock %}

{% block content %}

<h1>–†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å</h1>

<div class="workspace-container">

  <section class="calendar-table">

    <!-- === –§–∏–ª—å—Ç—Ä –ø–∞—Ä–∫–æ–≤–∫–∏ === -->
    <form method="GET" action="{{ url_for('workspace.view') }}" class="filter-form">
      <label for="parking_id">–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–∫–æ–≤–∫—É:</label>
      <select id="parking_id" name="parking_id" onchange="this.form.submit()">
        <option value="">–í—Å–µ</option>
        {% for parking in parkings %}
          <option value="{{ parking.parking_id }}"
                  {% if parking.parking_id == selected_parking_id %}selected{% endif %}>
            {{ parking.address }}
          </option>
        {% endfor %}
      </select>

      <div style="margin-top:8px;">
        <a class="btn"
           href="{{ url_for('workspace.view', parking_id=selected_parking_id, year_offset=year_offset - 1) }}">
          ‚Üê {{ current_year - 1 }}
        </a>

        <strong style="margin:0 10px;">{{ current_year }}</strong>

        <a class="btn"
           href="{{ url_for('workspace.view', parking_id=selected_parking_id, year_offset=year_offset + 1) }}">
          {{ current_year + 1 }} ‚Üí
        </a>
      </div>
    </form>

    <!-- –í–µ—Ä—Ö–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="top-actions">
      <a href="{{ url_for('workspace.add_parking') }}" class="btn-small green">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∫–æ–≤–∫—É</a>
      <a href="{{ url_for('workspace.add_spot') }}" class="btn-small green">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</a>
      <a href="{{ url_for('workspace.add_client') }}" class="btn-small green">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞</a>
      <a href="{{ url_for('workspace.clients') }}" class="btn-small red">üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞–º–∏</a>
    </div>

    <!-- === –¢–∞–±–ª–∏—Ü–∞ —à–∞—Ö–º–∞—Ç–∫–∏ === -->
    <table class="calendar-grid">
      <thead>
        <tr>
          <th>–ú–µ—Å—Ç–æ</th>
          {% for month in months %}
            <th>{{ month }}</th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>
      {% for spot in spots %}
        {% if not selected_parking_id or spot.parking_id == selected_parking_id %}
          <tr>
            <td class="place">
              ‚Ññ{{ spot.number }}
              <div class="small muted">
                ({{ spot.parking.address if spot.parking else '‚Äî' }})
              </div>
            </td>

            {% for month_index in range(1, 13) %}
              {% set b = spot.bookings_by_month.get(month_index) %}

              <td class="cell
    {% if b and b.status == '–∑–∞–Ω—è—Ç–æ' %}occupied
    {% elif b and b.status == '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ' %}reserved
    {% else %}free{% endif %}">

    {% if b %}
        <!-- –Ø—á–µ–π–∫–∞ —Å –±—Ä–æ–Ω—å—é -->
        <div class="cell-top">
            {% if b.client %}
                <a href="{{ url_for('workspace.client_card', client_id=b.client.client_id) }}"
                   class="tenant-link">
                    {{ b.client.name }}
                </a>
            {% else %}
                <span class="tenant-link red">[–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö]</span>
            {% endif %}
        </div>

        <div class="cell-bottom">
            {{ "%.0f"|format(b.rent_size or 0) }} ‚ÇΩ
        </div>

    {% else %}
        <!-- –°–≤–æ–±–æ–¥–Ω–∞—è —è—á–µ–π–∫–∞ -->
        <a href="{{ url_for(
            'workspace.client_card',
            client_id=0,
            spot_id=spot.spot_id,
            prefill_start=date(current_year, month_index, 1).isoformat(),
            prefill_end=(
                date(current_year, month_index + 1, 1) - timedelta(days=1)
            ).isoformat() if month_index < 12 else (
                date(current_year + 1, 1, 1) - timedelta(days=1)
            ).isoformat()
        ) }}" class="cell-link">

            <div class="cell-top">–°–≤–æ–±–æ–¥–Ω–æ</div>
            <div class="cell-bottom muted">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–æ–Ω—å</div>
        </a>
    {% endif %}
</td>
            {% endfor %}
          </tr>
        {% endif %}
      {% endfor %}
      </tbody>

    </table>

  </section>
</div>

{% endblock %}